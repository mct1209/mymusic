<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI 音樂 MV 生成器</title>
  <style>
    :root {
      --primary: #6a1b9a;
      --accent: #ff4081;
      --success: #4caf50;
      --danger: #f44336;
      --info: #2196F3;
      --warning: #ff9800;
      --light: #f8f9fa;
      --radius: 16px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', -apple-system, sans-serif; background: linear-gradient(135deg, #e3f2fd, #bbdefb); min-height: 100vh; padding: 16px; }
    .container { max-width: 720px; margin: 20px auto; background: white; border-radius: var(--radius); padding: 24px; box-shadow: 0 10px 35px rgba(0,0,0,0.15); }
    h1 { color: var(--primary); text-align: center; font-size: 1.9rem; margin-bottom: 8px; }
    .lang-switch { display: flex; justify-content: center; gap: 8px; margin: 16px 0; }
    .lang-btn { flex: 1; max-width: 100px; padding: 10px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
    .zh { background: var(--accent); color: white; }
    .en { background: #3f51b5; color: white; }
    .ja { background: var(--warning); color: white; }
    .lang-btn.active { transform: scale(1.08); box-shadow: 0 0 0 3px #ddd; }
    .mic-btn { width: 100%; padding: 18px; font-size: 1.2rem; font-weight: bold; border: none; border-radius: var(--radius); cursor: pointer; margin: 20px 0; transition: 0.3s; }
    .start { background: var(--info); color: white; }
    .stop { background: var(--danger); color: white; animation: pulse 1.5s infinite; }
    .disabled { background: #ccc !important; cursor: not-allowed !important; opacity: 0.7; }
    .file-input { text-align: center; margin: 16px 0; }
    .file-btn { background: var(--primary); color: white; padding: 14px 28px; border-radius: 12px; cursor: pointer; display: inline-block; font-weight: bold; }
    .file-btn input { display: none; }
    .progress { width: 100%; height: 14px; background: #e0e0e0; border-radius: 7px; margin: 20px 0; overflow: hidden; }
    .progress-bar { height: 100%; background: var(--success); width: 0%; transition: width 0.3s ease; }
    video { width: 100%; border-radius: var(--radius); margin: 24px 0; box-shadow: 0 6px 20px rgba(0,0,0,0.12); }
    .actions { display: flex; gap: 12px; justify-content: center; margin-top: 20px; }
    .actions button { flex: 1; max-width: 150px; padding: 14px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; }
    .regenerate { background: #607d8b; color: white; }
    .share { background: var(--success); color: white; }
    .alert { padding: 14px; border-radius: 10px; margin: 16px 0; font-size: 0.95rem; text-align: center; border-left: 5px solid; }
    .success { background: #e8f5e9; color: #2e7d32; border-color: #4caf50; }
    .error { background: #ffebee; color: #c62828; border-color: #e53935; }
    .retry-btn { margin-top: 10px; padding: 8px 16px; background: #2196F3; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    @media (max-width: 480px) {
      .container { padding: 16px; margin: 10px; }
      h1 { font-size: 1.6rem; }
      .mic-btn { font-size: 1.1rem; padding: 16px; }
      .actions { flex-direction: column; }
      .actions button { max-width: none; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>AI 音樂 MV 生成器</h1>

    <div id="alertBox"></div>

    <div class="lang-switch">
      <button class="lang-btn zh active" onclick="setLang('zh')">中文</button>
      <button class="lang-btn en" onclick="setLang('en')">EN</button>
      <button class="lang-btn ja" onclick="setLang('ja')">JA</button>
    </div>

    <button id="micBtn" class="mic-btn start" onclick="toggleRecord()">
      <span id="micText">開始唱歌</span>
    </button>

    <div class="file-input">
      <label class="file-btn" id="fileLabel">從檔案選擇音訊</label>
      <input type="file" id="audioFile" accept="audio/*" onchange="handleFile(this.files)"/>
    </div>

    <div id="progressContainer" class="progress" style="display:none;">
      <div id="progressBar" class="progress-bar"></div>
    </div>
    <p id="status" style="text-align:center; color:#666; min-height:28px;"></p>

    <video id="outputVideo" controls style="display:none;"></video>

    <div class="actions" id="actions" style="display:none;">
      <button class="regenerate" onclick="regenerate()">重新生成</button>
      <button class="share" onclick="share()">分享</button>
    </div>
  </div>

  <script>
    let isRecording = false;
    let mediaRecorder = null;
    let audioChunks = [];
    let currentLang = 'zh';
    let stream = null;
    let micAccess = false;

    const texts = {
      zh: { 
        start: "開始唱歌", stop: "停止錄音", select: "從檔案選擇音訊", 
        generating: "生成中...", regenerate: "重新生成", share: "分享",
        test: "測試麥克風中...", ok: "麥克風已就緒！點擊開始", 
        denied: "麥克風被拒絕！請至瀏覽器設定開啟", error: "無法存取麥克風", 
        retry: "重新測試", recording: "錄音中... 再次點擊停止"
      },
      en: { 
        start: "Start Singing", stop: "Stop Recording", select: "Select Audio File", 
        generating: "Generating...", regenerate: "Regenerate", share: "Share",
        test: "Testing mic...", ok: "Mic ready! Tap to record", 
        denied: "Mic blocked! Enable in settings", error: "Cannot access mic", 
        retry: "Retest", recording: "Recording... Tap to stop"
      },
      ja: { 
        start: "歌い始める", stop: "録音停止", select: "音声ファイルを選択", 
        generating: "生成中...", regenerate: "再生成", share: "共有",
        test: "マイクテスト中...", ok: "マイクOK！タップで録音", 
        denied: "マイク拒否！設定で許可", error: "マイクアクセス不可", 
        retry: "再テスト", recording: "録音中... タップで停止"
      }
    };

    function $(id) { return document.getElementById(id); }
    function showAlert(msg, type = 'success') {
      const box = $('alertBox');
      box.innerHTML = `<div class="alert ${type}">${msg}</div>`;
      box.style.display = 'block';
    }
    function clearAlert() { $('alertBox').style.display = 'none'; }

    function disableMic() { $('micBtn').classList.add('disabled'); $('micBtn').disabled = true; }
    function enableMic() { $('micBtn').classList.remove('disabled'); $('micBtn').disabled = false; }

    async function testMic() {
      showAlert(texts[currentLang].test, 'success');
      try {
        const s = await navigator.mediaDevices.getUserMedia({ audio: true });
        s.getTracks().forEach(t => t.stop());
        micAccess = true;
        showAlert(texts[currentLang].ok, 'success');
        enableMic();
      } catch (err) {
        micAccess = false;
        const msg = err.name === 'NotAllowedError' ? texts[currentLang].denied : texts[currentLang].error;
        showAlert(`${msg}<br><button class="retry-btn" onclick="testMic()">${texts[currentLang].retry}</button>`, 'error');
        disableMic();
      }
    }

    function setLang(lang) {
      currentLang = lang;
      document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
      document.querySelector(`.lang-btn.${lang}`).classList.add('active');
      updateUI();
      testMic();
    }

    function updateUI() {
      const t = texts[currentLang];
      $('micText').textContent = isRecording ? t.stop : t.start;
      $('fileLabel').textContent = t.select;
      document.querySelector('.regenerate').textContent = t.regenerate;
      document.querySelector('.share').textContent = t.share;
    }

    async function toggleRecord() {
      if (isRecording) {
        mediaRecorder.stop();
        stream.getTracks().forEach(t => t.stop());
        $('micBtn').classList.remove('stop'); $('micBtn').classList.add('start');
        isRecording = false;
        updateUI();
      } else {
        if (!micAccess) { await testMic(); if (!micAccess) return; }
        try {
          stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream);
          audioChunks = [];
          mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
          mediaRecorder.onstop = () => {
            const blob = new Blob(audioChunks, { type: 'audio/wav' });
            generateMV(blob);
          };
          mediaRecorder.start();
          $('micBtn').classList.remove('start'); $('micBtn').classList.add('stop');
          $('micText').textContent = texts[currentLang].recording;
          isRecording = true;
          showAlert(texts[currentLang].recording, 'success');
        } catch (err) {
          showAlert(texts[currentLang].error, 'error');
        }
      }
    }

    function handleFile(files) {
      if (files[0]) {
        const blob = new Blob([files[0]], { type: files[0].type });
        generateMV(blob);
      }
    }

    function generateMV(blob) {
      $('progressContainer').style.display = 'block';
      $('status').textContent = texts[currentLang].generating;
      let p = 0;
      const int = setInterval(() => {
        p += 10;
        $('progressBar').style.width = p + '%';
        if (p >= 100) {
          clearInterval(int);
          setTimeout(() => {
            $('progressContainer').style.display = 'none';
            $('status').textContent = '';
            const v = $('outputVideo');
            v.src = 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4';
            v.style.display = 'block';
            $('actions').style.display = 'flex';
          }, 600);
        }
      }, 300);
    }

    function regenerate() {
      $('outputVideo').style.display = 'none';
      $('actions').style.display = 'none';
      $('progressBar').style.width = '0%';
      generateMV(null);
    }

    function share() {
      if (navigator.share) {
        navigator.share({ title: '我的 AI 音樂 MV', url: location.href });
      } else {
        navigator.clipboard.writeText(location.href);
        alert('連結已複製！');
      }
    }

    window.onload = () => {
      updateUI();
      testMic();
    };
  </script>
</body>
</html>
